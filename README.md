# **Terraform AWS ElastiCache for Redis Module **

This Terraform module provisions AWS ElastiCache for Redis, supporting both **Serverless** and **Traditional (Self-Designed/Clustered)** deployment models. It enforces tagging best practices, manages security groups, and provides robust configuration options for various Redis setups. Serverless is the default deployment option.

## Features
---
-   **Dual Deployment Models**:
    -   **Serverless Redis**: Default option, offering simplicity and auto-scaling.
    -   **Traditional Redis**: Supports standalone (non-replicated), replicated, and cluster-mode enabled configurations using ElastiCache Replication Groups. The `cluster_mode_enabled` input variable controls whether the module configures a sharded (cluster mode) or non-sharded replication group.
-   **Mandatory Tagging**: Enforces `AIT` (Application Identification Token), `Environment`, and `RTO` tags, along with custom tags.
-   **Security**:
    -   Creates a dedicated ElastiCache Security Group.
    -   Configurable ingress rules from specified Security Groups or CIDR blocks (restricting access from within the account/VPC).
-   **Encryption**:
    -   **At-Rest Encryption**:
        -   Serverless: Always encrypted at rest. Uses an AWS-owned key by default, or a Customer Managed Key (CMK) if `kms_key_id` is provided.
        -   Traditional: Enabled by default via `at_rest_encryption_enabled`. Uses an AWS-managed key by default, or a CMK if `kms_key_id` is provided.
    -   **In-Transit Encryption (TLS)**:
        -   Serverless: Always enabled.
        -   Traditional: Enabled by default via `transit_encryption_enabled`. Strongly recommended, and required if `auth_token` is used.
-   **Authentication (Traditional)**:
    -   Supports `auth_token` for password protection on traditional deployments.
    -   If `transit_encryption_enabled` is true and `auth_token` is not supplied, a random token is generated by the module.
-   **Consolidated Snapshot Management**:
    -   Uses `snapshot_retention_days` and `daily_snapshot_window_utc` for both Serverless and Traditional deployments. For Serverless, only the start time of the `daily_snapshot_window_utc` is used. Ensure snapshot and maintenance windows do not overlap for Traditional deployments.
-   **Comprehensive Resource Management**:
    -   `aws_elasticache_serverless_cache`
    -   `aws_elasticache_replication_group`
    -   `aws_elasticache_subnet_group`
    -   `aws_elasticache_parameter_group` (for Traditional)
    -   `aws_elasticache_global_replication_group` (optional, for Traditional)
    -   `aws_elasticache_cluster` (optional, for very basic single-node Redis; `replication_group` is generally preferred)
-   **Highly Parameterized**: Numerous inputs to customize node types, engine versions, specific limits, etc.
-   **Examples**: Multiple usage examples provided, including low-cost configurations for testing.

## Prerequisites

-   Terraform `v1.3.0` or newer.
-   AWS Provider `~> 5.20` (or compatible `v5.x`). The behavior of `aws_elasticache_replication_group` regarding cluster mode requires careful handling of mutually exclusive arguments, for which a recent provider version is recommended.
-   A VPC with private subnets. ElastiCache should generally not be in public subnets.
-   If using CMEK for encryption, a pre-existing KMS key ARN.

## Usage

Below are basic examples. Refer to the `examples/` directory for more detailed use cases.
The `var.cluster_mode_enabled` input variable is a helper for the module user to indicate intent. The module then sets the appropriate arguments (`num_node_groups`/`replicas_per_node_group` vs. `num_cache_clusters`) on the `aws_elasticache_replication_group` resource.

**Important Note for Traditional Cluster Mode (`cluster_mode_enabled = true`):**
When creating a sharded (cluster mode) traditional ElastiCache deployment, you **must** include `{ name = "cluster-enabled", value = "yes" }` within the `parameter_group_parameters` input if using a standard parameter group family like `redis7` or `redis6.x`. This configures the parameter group itself to support sharding.

### **Serverless Redis (Low-Cost Default) **

module "my_serverless_cache" {
  source = "[[your-git-repo-url]]/terraform-aws-elasticache-redis?ref=v1.0.0" // Or local path: "./"

  name_prefix     = "test-srvls"
  ait_tag         = "AITTESTSLC"
  environment_tag = "test"
  rto_tag         = "None"

  vpc_id     = "vpc-xxxxxxxxxxxxxxxxx"
  subnet_ids = ["subnet-xxxxxxxxxxxxxxxxx", "subnet-yyyyyyyyyyyyyyyyy"]

  allowed_security_group_ids = ["sg-appserverxxxxxxxx"]
  kms_key_id                 = null
  serverless_cache_usage_limits = null
  
  snapshot_retention_days   = 1
  daily_snapshot_window_utc = "04:00-05:00" # Start time 04:00 used for Serverless
}

### **Traditional Redis - Cluster Mode Enabled **

module "my_clustered_traditional_cache" {
  source = "[[your-git-repo-url]]/terraform-aws-elasticache-redis?ref=v1.0.0"

  name_prefix     = "trad-cluster"
  ait_tag         = "AITTRDCLUS"
  environment_tag = "staging"
  rto_tag         = "2h"

  deployment_option    = "traditional"
  cluster_mode_enabled = true

  vpc_id     = "vpc-xxxxxxxxxxxxxxxxx"
  subnet_ids = ["subnet-xxxxxxxxxxxxxxxxx", "subnet-yyyyyyyyyyyyyyyyy", "subnet-zzzzzzzzzzzzzzzzz"]

  allowed_security_group_ids = ["sg-appserverxxxxxxxx"]
  kms_key_id                 = "arn:aws:kms:us-east-1:123456789012:key/your-kms-key-id"

  engine_version         = "7.1"
  parameter_group_family = "redis7" 
  node_type              = "cache.m6g.large"

  num_node_groups         = 2 
  replicas_per_node_group = 1 

  automatic_failover_enabled = true
  multi_az_enabled           = true

  # Ensure these do not overlap
  daily_snapshot_window_utc = "04:00-05:00"
  maintenance_window        = "sun:02:00-sun:03:00" # Module default, or override here

  parameter_group_parameters = [
    { name = "cluster-enabled", value = "yes" }
  ]
}


# Terraform AWS ElastiCache for Redis Module

This Terraform module provisions AWS ElastiCache for Redis, supporting both **Serverless** and **Traditional (Self-Designed/Clustered)** deployment models. It enforces tagging best practices, manages security groups, and provides robust configuration options for various Redis setups. Serverless is the default deployment option.

## Features
---
-   **Dual Deployment Models**:
    -   **Serverless Redis**: Default option, offering simplicity and auto-scaling.
    -   **Traditional Redis**: Supports standalone (non-replicated), replicated, and cluster-mode enabled configurations using ElastiCache Replication Groups. The `cluster_mode_enabled` input variable controls whether the module configures a sharded (cluster mode) or non-sharded replication group.
-   **Mandatory Tagging**: Enforces `AIT` (Application Identification Token), `Environment`, and `RTO` tags, along with custom tags.
-   **Security**:
    -   Creates a dedicated ElastiCache Security Group.
    -   Configurable ingress rules from specified Security Groups or CIDR blocks (restricting access from within the account/VPC).
-   **Encryption**:
    -   **At-Rest Encryption**:
        -   Serverless: Always encrypted at rest. Uses an AWS-owned key by default, or a Customer Managed Key (CMK) if `kms_key_id` is provided.
        -   Traditional: Enabled by default via `at_rest_encryption_enabled`. Uses an AWS-managed key by default, or a CMK if `kms_key_id` is provided.
    -   **In-Transit Encryption (TLS)**:
        -   Serverless: Always enabled.
        -   Traditional: Enabled by default via `transit_encryption_enabled`. Strongly recommended, and required if `auth_token` is used.
-   **Authentication (Traditional)**:
    -   Supports `auth_token` for password protection on traditional deployments.
    -   If `transit_encryption_enabled` is true and `auth_token` is not supplied, a random token is generated by the module.
-   **Consolidated Snapshot Management**:
    -   Uses `snapshot_retention_days` and `daily_snapshot_window_utc` for both Serverless and Traditional deployments. For Serverless, only the start time of the `daily_snapshot_window_utc` is used. Ensure snapshot and maintenance windows do not overlap for Traditional deployments (module defaults are now non-overlapping).
-   **Comprehensive Resource Management**:
    -   `aws_elasticache_serverless_cache`
    -   `aws_elasticache_replication_group`
    -   `aws_elasticache_subnet_group`
    -   `aws_elasticache_parameter_group` (for Traditional)
    -   `aws_elasticache_global_replication_group` (optional, for Traditional)
    -   `aws_elasticache_cluster` (optional, for very basic single-node Redis; `replication_group` is generally preferred)
-   **Highly Parameterized**: Numerous inputs to customize node types, engine versions, specific limits, etc.
-   **Examples**: Multiple usage examples provided, including low-cost configurations for testing.

## Prerequisites

-   Terraform `v1.3.0` or newer.
-   AWS Provider `~> 5.20` (or compatible `v5.x`). The behavior of `aws_elasticache_replication_group` regarding cluster mode requires careful handling of mutually exclusive arguments, for which a recent provider version is recommended.
-   A VPC with private subnets. ElastiCache should generally not be in public subnets.
-   If using CMEK for encryption, a pre-existing KMS key ARN.

## Usage

Below are basic examples. Refer to the `examples/` directory for more detailed use cases.
The `var.cluster_mode_enabled` input variable is a helper for the module user to indicate intent. The module then sets the appropriate arguments (`num_node_groups`/`replicas_per_node_group` vs. `num_cache_clusters`) on the `aws_elasticache_replication_group` resource.

**Important Note for Traditional Cluster Mode (`cluster_mode_enabled = true`):**
When creating a sharded (cluster mode) traditional ElastiCache deployment, you **must** include `{ name = "cluster-enabled", value = "yes" }` within the `parameter_group_parameters` input if using a standard parameter group family like `redis7` or `redis6.x`. This configures the parameter group itself to support sharding.

### Serverless Redis (Low-Cost Default)
---
```terraform
module "my_serverless_cache" {
  source = "[[your-git-repo-url]]/terraform-aws-elasticache-redis?ref=v1.0.0" // Or local path: "./"

  name_prefix     = "test-srvls"
  ait_tag         = "AITTESTSLC"
  environment_tag = "test"
  rto_tag         = "None"

  vpc_id     = "vpc-xxxxxxxxxxxxxxxxx"
  subnet_ids = ["subnet-xxxxxxxxxxxxxxxxx", "subnet-yyyyyyyyyyyyyyyyy"]

  allowed_security_group_ids = ["sg-appserverxxxxxxxx"]
  kms_key_id                 = null
  serverless_cache_usage_limits = null
  
  snapshot_retention_days   = 1
  daily_snapshot_window_utc = "04:00-05:00" # Module default, start time 04:00 used for Serverless
}
```
### Traditional Redis - Cluster Mode Enabled
```terraform
module "my_clustered_traditional_cache" {
  source = "[[your-git-repo-url]]/terraform-aws-elasticache-redis?ref=v1.0.0"

  name_prefix     = "trad-cluster"
  ait_tag         = "AITTRDCLUS"
  environment_tag = "staging"
  rto_tag         = "2h"

  deployment_option    = "traditional"
  cluster_mode_enabled = true

  vpc_id     = "vpc-xxxxxxxxxxxxxxxxx"
  subnet_ids = ["subnet-xxxxxxxxxxxxxxxxx", "subnet-yyyyyyyyyyyyyyyyy", "subnet-zzzzzzzzzzzzzzzzz"]

  allowed_security_group_ids = ["sg-appserverxxxxxxxx"]
  kms_key_id                 = "arn:aws:kms:us-east-1:123456789012:key/your-kms-key-id"

  engine_version         = "7.1"
  parameter_group_family = "redis7" 
  node_type              = "cache.m6g.large"

  num_node_groups         = 2 
  replicas_per_node_group = 1 

  automatic_failover_enabled = true
  multi_az_enabled           = true

  # Using module defaults which are non-overlapping:
  # daily_snapshot_window_utc = "04:00-05:00"
  # maintenance_window        = "sun:02:00-sun:03:00" 
  # Or override them explicitly if needed, ensuring no overlap:
  # daily_snapshot_window_utc = "05:00-06:00" 
  # maintenance_window        = "sun:03:00-sun:04:00"

  parameter_group_parameters = [
    { name = "cluster-enabled", value = "yes" }, // Required for cluster_mode_enabled=true
    // { name = "notify-keyspace-events", value = "KEA" }
  ]
}
```


## **Inputs
|Name | Description | Type | Default | Required |
|---- | ----------- | ---- | ------- | -------- |
ait_tag | Application Identification Token (AIT) tag. | string |  | yes
allowed_cidr_blocks | List of CIDR blocks that are allowed to access ElastiCache on port 6379. | list(string) | [] | no
allowed_security_group_ids | List of security group IDs that are allowed to access ElastiCache on port 6379. | list(string) | [] | no
apply_immediately | For Traditional: Specifies whether modifications are applied immediately or during the next maintenance window. | bool | false | no
at_rest_encryption_enabled | For Traditional: Enable at-rest encryption. If true and kms_key_id is provided, CMEK is used. If kms_key_id is null, an AWS-managed key is used. Serverless is always encrypted at rest. | bool | true | no
auth_token | For Traditional: The password (auth token). Min 16, Max 128 alphanumeric characters. If null and transit_encryption_enabled is true, a random one is generated. | string | null | no
automatic_failover_enabled | For Traditional: Specifies if a read-only replica is automatically promoted on primary failure. Requires replicas_per_node_group > 0 (or relevant cluster setup). | bool | true | no
cluster_mode_enabled | Set to true to indicate intent for Redis Cluster Mode (sharded) for traditional deployment. The module uses this to set appropriate arguments on aws_elasticache_replication_group. | bool | false | no
create_global_replication_group | Set to true to create a global replication group (traditional only). | bool | false | no
create_standalone_redis_cluster_resource | Set to true to create a standalone aws_elasticache_cluster (single node Redis, non-replicated). Use with caution; 'traditional' deployment_option with replication_group is generally preferred for Redis. | bool | false | no
custom_tags | A map of additional custom tags to apply to all resources. | map(string) | {} | no
daily_snapshot_window_utc | The daily time range (in UTC) during which ElastiCache begins taking a daily snapshot. Format: HH:MM-HH:MM (e.g., '03:00-04:00'). For Serverless ElastiCache, only the start time of this window is used. Ensure this window does not overlap with the maintenance_window for Traditional deployments. | string | "04:00-05:00" | no
deployment_option | Deployment model for ElastiCache Redis. Options: 'serverless' or 'traditional'. | string | "serverless" | no
engine_version | Redis engine version for traditional deployment (e.g., '6.x', '7.0', '7.1'). | string | "7.1" | no
environment_tag | Environment tag (e.g., dev, staging, prod). | string |  | yes
global_replication_group_id_suffix | Suffix for the Global Replication Group ID (traditional only). | string | "global-redis" | no
kms_key_id | The ARN of the AWS KMS Customer Managed Key (CMK) to use for at-rest encryption. Serverless is always encrypted at rest (uses AWS-owned key if this is null). For Traditional, if at_rest_encryption_enabled is true, this key is used for CMEK (AWS-managed if null). | string | null | no
maintenance_window | For Traditional: Weekly time range for system maintenance. Format: ddd:hh24:mi-ddd:hh24:mi (e.g., 'sun:03:00-sun:04:00'). Ensure this window does not overlap with the daily_snapshot_window_utc. | string | "sun:02:00-sun:03:00" | no
multi_az_enabled | For Traditional: Specifies whether to enable Multi-AZ Support. Typically true if automatic_failover_enabled is true and replicas exist. | bool | true | no
name_prefix | A prefix used for naming resources. Ensures uniqueness and context. Example: 'myapp-prod-cache'. | string |  | yes
node_type | The cache node type for traditional deployment (e.g., 'cache.t3.small', 'cache.m6g.large'). | string | "cache.t3.small" | no
num_node_groups | Number of node groups (shards) for Redis (used when cluster_mode_enabled is true). | number | 1 | no
parameter_group_family | Parameter group family for traditional Redis (e.g., 'redis6.x', 'redis7'). This should be the base family name (e.g., 'redis7' for Redis 7.x). For cluster mode, ensure this family supports the 'cluster-enabled' parameter if you set it. | string | "redis7" | no
parameter_group_parameters | For Traditional: A list of parameters to apply to the custom parameter group. If cluster_mode_enabled is true, you MUST include { name = "cluster-enabled", value = "yes" } in this list for compatible families like 'redis6.x' or 'redis7'. | list(object({ name = string, value = string })) | [] | no
replicas_per_node_group | Number of read replicas per node group (shard) for traditional Redis. For non-cluster mode (cluster_mode_enabled=false), this determines the number of replicas for the single primary. Set to 0 for a single-node primary with no replicas. | number | 1 | no
replication_group_description | Description for the replication group. | string | "Managed by Terraform" | no
replication_group_id_prefix | Prefix for the replication group ID for traditional Redis. Final ID: <prefix>-<name_prefix>-rg. If empty, <name_prefix>-rg is used. | string | "" | no
rto_tag | Recovery Time Objective (RTO) tag. | string |  | yes
serverless_cache_name | The user-defined name for the ElastiCache Serverless cache. If not provided, one will be generated using name_prefix. Must be unique. | string | "" | no
serverless_cache_usage_limits | Configuration for serverless cache usage limits. See AWS docs for ElastiCacheServerless.CacheUsageLimits. Set to null to use AWS defaults. | object({ data_storage = optional(object({ maximum = number, unit = string })), ecpu_per_second = optional(object({ maximum = number })) }) | null | no
serverless_engine | The engine for serverless cache (currently only 'redis'). | string | "redis" | no
serverless_major_engine_version | The major engine version for the serverless cache (e.g., '7'). | string | "7" | no
snapshot_retention_days | Number of days to retain automated snapshots. For Traditional, 0 disables snapshots. For Serverless, the minimum is 1 day (if 0 is provided, the module will use 1). | number | 7 | no
standalone_cluster_id | ID for the standalone ElastiCache cluster. | string | "" | no
standalone_engine_version | Engine version for standalone cluster (e.g., '7.0'). | string | "7.0" | no
standalone_node_type | Node type for standalone cluster (e.g., 'cache.t3.micro'). | string | "cache.t3.micro" | no
standalone_parameter_group_name | Parameter group name for standalone cluster (e.g., 'default.redis7'). User must ensure this is valid for the standalone_engine_version. | string | "default.redis7" | no
subnet_ids | A list of subnet IDs for the ElastiCache subnet group. Required for both serverless and traditional. Provide subnets from different AZs for high availability. | list(string) |  | yes
transit_encryption_enabled | For Traditional: Enable in-transit encryption (TLS). Strongly recommended and required if an auth_token is used. For Serverless: This is ignored as Serverless connections are always TLS encrypted. | bool | true | no
vpc_id | The ID of the VPC where ElastiCache will be deployed. | string |  | yes
---
## **Outputs

|Name | Description | Sensitive|
|-----|-------------|----------|
elasticache_security_group_id | The ID of the security group created for ElastiCache. | false
elasticache_subnet_group_name | The name of the ElastiCache subnet group. | false
global_replication_group_id | ID of the Global Replication Group, if created. | false
replication_group_arn | ARN of the Traditional ElastiCache Replication Group. | false
replication_group_auth_token_enabled | Indicates if an auth_token is configured for the traditional replication group. | true
replication_group_generated_auth_token | The generated auth token if one was created by the module. Store this securely. N/A if auth_token was provided by the user. | true
replication_group_id | ID of the Traditional ElastiCache Replication Group. | false
replication_group_member_clusters | List of member cluster IDs in the Traditional ElastiCache Replication Group. | false
replication_group_parameter_group_name | Name of the parameter group used by the traditional replication group. | false
replication_group_primary_endpoint_address | Primary endpoint address for the Traditional ElastiCache Replication Group. For cluster mode enabled, this is the configuration endpoint. | false
replication_group_reader_endpoint_address | Reader endpoint address for the Traditional ElastiCache Replication Group (if applicable, not for cluster mode enabled or single node). | false
serverless_cache_arn | ARN of the Serverless Cache. | false
serverless_cache_endpoint_address | Endpoint address for the Serverless Cache. | false
serverless_cache_endpoint_port | Endpoint port for the Serverless Cache. | false
serverless_cache_name | Name of the Serverless Cache. | false
serverless_cache_reader_endpoint_address | Reader endpoint address for the Serverless Cache. | false
serverless_cache_reader_endpoint_port | Reader endpoint port for the Serverless Cache. | false
standalone_cluster_cache_nodes | List of cache nodes in the standalone cluster. | false
standalone_cluster_configuration_endpoint | Configuration endpoint for the standalone cluster (primary node endpoint). | false
standalone_cluster_id_output | ID of the standalone ElastiCache cluster (aws_elasticache_cluster resource), if created.